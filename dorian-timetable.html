<!DOCTYPE html>
<html lang="bs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dorian's Timetable</title>

    <link rel="icon" type="image/png" href="favicon-1.png">
    <link rel="apple-touch-icon" href="favicon-1.png">

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color-dark: #2c3e50;
            --secondary-color-dark: #34495e;
            --card-bg-dark: #4a657c;
            --text-color-dark: #ecf0f1;
            --highlight-bg-dark: #27ae60;
            --highlight-text-dark: #fff;
            --green-text-dark: #2ecc71;
            --hover-bg-dark: #5e7d98;
            --upcoming-border-dark: #f1c40f;
            --upcoming-bg-dark: rgba(241, 196, 15, 0.08);
            --countdown-text-dark: #f39c12;

            --primary-color-light: #ecf0f1;
            --secondary-color-light: #bdc3c7;
            --card-bg-light: #dfe6ee;
            --text-color-light: #2c3e50;
            --highlight-bg-light: #27ae60;
            --highlight-text-light: #2c3e50;
            --green-text-light: #27ae60;
            --hover-bg-light: #cad3dc;
            --upcoming-border-light: #d35400;
            --upcoming-bg-light: rgba(230, 126, 34, 0.1);
            --countdown-text-light: #d35400;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--primary-color-dark);
            color: var(--text-color-dark);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }

        body.light-mode {
            background-color: var(--primary-color-light);
            color: var(--text-color-light);
        }

        .container {
            width: 100%;
            max-width: 1200px;
            padding: 10px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2em;
            font-weight: 600;
            color: var(--text-color-dark);
            cursor: progress;
            -webkit-user-select: none;  /* Safari */
            -ms-user-select: none;      /* IE 10 and IE 11 */
            user-select: none;          /* Standard syntax */
        }

        body.light-mode h1 {
            color: var(--text-color-light);
        }
        
        #datetime-display {
            font-size: 1.1em;
            font-weight: 400;
            color: #95a5a6;
            margin-top: -10px;
        }

        .shift-info {
            font-size: 1em;
            font-style: italic;
            color: var(--text-color-dark);
            margin-top: -10px;
        }

        body.light-mode .shift-info {
            color: var(--text-color-light);
        }
        
        .controls {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .controls button, .controls select {
            background-color: var(--secondary-color-dark);
            color: var(--text-color-dark);
            border: 2px solid var(--text-color-dark);
            padding: 10px 15px;
            border-radius: 20px;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s, transform 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        body.light-mode .controls button, body.light-mode .controls select {
            background-color: var(--secondary-color-light);
            color: var(--text-color-light);
            border: 2px solid var(--text-color-light);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .controls button:hover, .controls select:hover {
            transform: translateY(-2px);
            background-color: var(--hover-bg-dark);
        }
        
        body.light-mode .controls button:hover, body.light-mode .controls select:hover {
            background-color: var(--hover-bg-light);
        }
        
        #simulation-controls {
            display: none;
            background-color: var(--card-bg-dark);
            padding: 20px;
            margin: 20px auto;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 500px;
        }

        body.light-mode #simulation-controls {
            background-color: var(--card-bg-light);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        #simulation-controls.visible {
            display: block;
        }

        #simulation-controls input, #simulation-controls button {
             background-color: var(--secondary-color-dark);
            color: var(--text-color-dark);
            border: 2px solid var(--text-color-dark);
            padding: 8px 12px;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            margin: 5px;
        }

        body.light-mode #simulation-controls input, body.light-mode #simulation-controls button {
            background-color: var(--secondary-color-light);
            color: var(--text-color-light);
            border: 2px solid var(--text-color-light);
        }

        #current-schedule, #exam-schedule {
            text-align: center;
            margin-bottom: 40px;
        }

        .card {
            background-color: var(--card-bg-dark);
            border-radius: 12px;
            padding: 25px;
            padding-bottom: 35px; /* Added space for progress bar */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            margin-top: 20px;
            text-align: center;
            transition: background-color 0.3s;
            position: relative; /* Added for positioning progress bar */
            overflow: hidden; /* Added to contain progress bar */
        }

        body.light-mode .card {
            background-color: var(--card-bg-light);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .status-label {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--green-text-dark);
            margin-bottom: 5px;
        }
        
        body.light-mode .status-label {
            color: var(--green-text-light);
        }

        .lesson-name {
            font-size: 1.8em;
            font-weight: 600;
            margin: 10px 0;
        }

        .lesson-time {
            font-size: 1em;
            font-style: italic;
            color: #bdc3c7;
        }
        
        .lesson-time.weekend-message {
            font-style: normal;
            font-size: 1.1em;
            line-height: 1.5;
        }
        
        body.light-mode .lesson-time {
            color: #7f8c8d;
        }

        .progress-bar-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background-color: rgba(0, 0, 0, 0.2);
            display: none; /* Hidden by default */
        }

        .progress-bar-fill {
            height: 100%;
            width: 0%;
            background-color: var(--green-text-dark);
            transition: width 0.5s linear;
        }

        body.light-mode .progress-bar-fill {
             background-color: var(--green-text-light);
        }
        
        #exam-list {
            text-align: left;
            padding: 10px 20px;
        }

        .exam-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            padding: 12px 10px;
            border-bottom: 1px solid var(--secondary-color-dark);
            transition: all 0.3s;
            border-left: 4px solid transparent;
            margin: 2px 0;
        }

        body.light-mode .exam-item {
            border-bottom: 1px solid var(--secondary-color-light);
        }

        .exam-item:last-child {
            border-bottom: none;
        }

        .exam-subject {
            font-weight: 600;
            font-size: 1.1em;
            white-space: nowrap;
        }
        
        .exam-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            font-style: italic;
            color: #bdc3c7;
            font-size: 0.95em;
        }
        
        body.light-mode .exam-info {
            color: #7f8c8d;
        }
        
        .exam-info .countdown {
            font-weight: bold;
            color: var(--countdown-text-dark);
        }
        
        body.light-mode .exam-info .countdown {
            color: var(--countdown-text-light);
        }

        .exam-item.past {
            opacity: 0.5;
            text-decoration: line-through;
        }
        
        .exam-item.upcoming {
            border-left: 4px solid var(--upcoming-border-dark);
            background-color: var(--upcoming-bg-dark);
        }
        
        body.light-mode .exam-item.upcoming {
            border-left-color: var(--upcoming-border-light);
            background-color: var(--upcoming-bg-light);
        }

        #full-schedule h2, #mobile-schedule h2, #exam-schedule h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        .table-container {
            overflow-x: auto;
            background-color: var(--secondary-color-dark);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s;
        }

        body.light-mode .table-container {
            background-color: var(--secondary-color-light);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            text-align: center;
            table-layout: auto;
        }

        th, td {
            padding: 12px 8px;
            border: 1px solid #7f8c8d;
        }
        
        thead th, #mobile-schedule thead th {
            background-color: var(--secondary-color-dark);
            color: var(--text-color-dark);
            font-weight: 600;
            transition: background-color 0.3s, color 0.3s;
        }

        body.light-mode thead th, body.light-mode #mobile-schedule thead th {
            background-color: var(--secondary-color-light);
            color: var(--text-color-light);
        }

        tr:nth-child(even) {
            background-color: #3e566b;
        }

        body.light-mode tr:nth-child(even) {
            background-color: #d1d9e2;
        }

        td {
            transition: background-color 0.3s;
        }

        body.light-mode td {
            color: var(--text-color-light);
        }

        td:hover {
            background-color: var(--hover-bg-dark);
        }

        body.light-mode td:hover {
            background-color: var(--hover-bg-light);
        }

        .current-lesson {
            position: relative;
            color: var(--highlight-text-dark);
            font-weight: 600;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.5);
            transform: scale(1.02);
            transition: transform 0.2s ease-in-out;
            overflow: hidden;
            z-index: 1;
        }
        
        body.light-mode .current-lesson {
            color: var(--highlight-text-light);
            box-shadow: 0 0 10px rgba(241, 196, 15, 0.5);
        }

        .lesson-highlight {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--highlight-bg-dark);
            z-index: -1;
            transition: height linear;
        }
        
        body.light-mode .lesson-highlight {
            background-color: var(--highlight-bg-light);
        }

        #mobile-schedule {
            display: none;
        }
        
        /* --- NEW MODAL STYLES --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-popup {
            background-color: var(--card-bg-dark);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 90%;
            width: 450px;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .modal-overlay.visible .modal-popup {
            transform: scale(1);
        }

        body.light-mode .modal-popup {
            background-color: var(--card-bg-light);
        }
        
        .modal-popup h2 {
            margin-top: 0;
            font-size: 1.5em;
            color: var(--text-color-dark);
        }
        
        body.light-mode .modal-popup h2 {
             color: var(--text-color-light);
        }

        .modal-popup p {
            margin-bottom: 25px;
            font-size: 1.1em;
            line-height: 1.6;
        }

        .modal-popup button {
            background-color: var(--highlight-bg-dark);
            color: var(--highlight-text-dark);
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            font-size: 1em;
        }
        
        body.light-mode .modal-popup button {
            background-color: var(--highlight-bg-light);
            color: var(--highlight-text-light);
        }

        .modal-popup button:hover {
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            body { padding: 10px; }
            h1 { font-size: 1.8em; }
            .lesson-name { font-size: 1.5em; }
            th, td { font-size: 0.8em; min-width: 150px; }
            .table-container { padding: 5px; }
            .exam-item { flex-direction: column; align-items: flex-start; gap: 5px; }
            .exam-info { align-items: flex-start; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls">
            <button id="mode-toggle">‚òÄÔ∏è Tamni</button>
            <select id="language-selector">
                <option value="bs">üáßüá¶ BA</option>
                <option value="en">üá¨üáß EN</option>
                <option value="tr">üáπüá∑ TR</option>
                <option value="it">üáÆüáπ IT</option>
                <option value="sq">üá¶üá± SQ</option>
            </select>
            <button id="view-toggle">Prikaz sedmice</button>
        </div>
        
        <div id="simulation-controls">
            <h3>Time Simulation</h3>
            <input type="datetime-local" id="sim-datetime-picker">
            <button id="sim-apply-btn">Simulate Time</button>
            <button id="sim-reset-btn">Reset to Real-Time</button>
        </div>


        <header>
            <h1 id="main-title">Dorian's Timetable</h1>
            <p id="datetime-display"></p>
            <p class="shift-info"></p>
        </header>
        
        <main>
            <section id="current-schedule">
                <h2 id="current-title">Trenutni raspored</h2>
                <div id="current-lesson" class="card">
                    <p class="status-label"></p>
                    <p class="lesson-name"></p>
                    <p class="lesson-time"></p>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill"></div>
                    </div>
                </div>
            </section>

            <section id="full-schedule">
                <h2 id="full-title">Cijeli Sedmiƒçni Raspored</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr id="table-header">
                                <th>Vrijeme</th>
                                <th>Ponedjeljak</th>
                                <th>Utorak</th>
                                <th>Srijeda</th>
                                <th>ƒåetvrtak</th>
                                <th>Petak</th>
                            </tr>
                        </thead>
                        <tbody id="timetable-body"></tbody>
                    </table>
                </div>
            </section>

            <section id="mobile-schedule">
                <h2 id="mobile-title">Dana≈°nji Raspored</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th id="mobile-time-header">Vrijeme</th>
                                <th id="mobile-day-header">Ponedjeljak</th>
                            </tr>
                        </thead>
                        <tbody id="mobile-timetable-body"></tbody>
                    </table>
                </div>
            </section>

            <section id="exam-schedule">
                <h2 id="exam-title">Nadolazeƒái Ispiti</h2>
                <div id="exam-list" class="card">
                    </div>
            </section>
        </main>
    </div>

    <div class="modal-overlay" id="exam-modal-overlay">
        <div class="modal-popup">
            <h2 id="exam-modal-title"></h2>
            <p id="exam-modal-body"></p>
            <button id="exam-modal-close-btn"></button>
        </div>
    </div>


<script>
    const SCHEDULES = {
        morning: {
            shiftNameKey: "morningShift",
            shiftTimes: "(08:00 - 11:30)",
            time_slots: [
                { start: "08:00", end: "08:45" },
                { start: "08:50", end: "09:35" },
                { start: "09:35", end: "09:55", type: "break" },
                { start: "09:55", end: "10:40" },
                { start: "10:45", end: "11:30" }
            ]
        },
        afternoon: {
            shiftNameKey: "afternoonShift",
            shiftTimes: "(14:00 - 17:30)",
            time_slots: [
                { start: "14:00", end: "14:45" },
                { start: "14:50", end: "15:35" },
                { start: "15:35", end: "15:55", type: "break" },
                { start: "15:55", end: "16:40" },
                { start: "16:45", end: "17:30" }
            ]
        }
    };

    const EXAMS = [
        { date: "2025-09-11", time: "09:55", subjectKey: "bhs" },
        { date: "2025-10-21", time: "08:50", subjectKey: "bhs" },
        { date: "2025-10-27", time: "08:00", subjectKey: "eng" },
        { date: "2025-12-01", time: "09:55", subjectKey: "math" },
        { date: "2025-12-09", time: "10:45", subjectKey: "bhs" },
        { date: "2025-12-22", time: "08:50", subjectKey: "eng" }
    ];

    // UPDATED TRANSLATIONS FOR MODAL
    const TRANSLATIONS = {
        bs: {
            mainTitle: "Dorian's Timetable", dark: "Tamni", light: "Svijetli", viewToggleWeekly: "Prikaz sedmice", viewToggleDaily: "Prikaz dana", currentTitle: "Trenutni raspored", fullTitle: "Cijeli Sedmiƒçni Raspored", mobileTitle: "Dana≈°nji Raspored", timeHeader: "Vrijeme", days: ["Ponedjeljak", "Utorak", "Srijeda", "ƒåetvrtak", "Petak"], lessonStatus: "Trenutni ƒåas", breakName: "PAUZA", breakStatus: "Pauza", firstLessonIs: "Dana≈°nji prvi ƒças je", beforeSchoolStatus: "Nastava poƒçinje uskoro", beforeSchoolCountdown: "Nastava poƒçinje za", finishedStatus: "Nastava je zavr≈°ila!", fridayFinishedTitle: "Nastava je zavr≈°ila!", fridayFinishedSubtitle: "Ugodan vikend! Ne zaboravite zavr≈°iti zadaƒáu za sljedeƒáu sedmicu i ponoviti ono ≈°to ste nauƒçili.", morningShift: "Prva smjena", afternoonShift: "Druga smjena", weekendMessage: "U≈æivajte u vikendu, pripremite se za nadolazeƒáu sedmicu!", nextLessonIn: "Sljedeƒái ƒças za", weekendPreviewTitle: "Sedmica je gotova!", weekendPreviewSubtitle: "Sljedeƒáe sedmice nastava je u", examTitle: "Raspored Ispita",
            examInDays: "za {days} dana", examInOneDay: "za 1 dan", examToday: "danas",
            examPopup: {
                title: "üö® Upozorenje o Ispitu üö®",
                body: "Ispit iz predmeta {subject} je {countdown}!<br><br>Ponavljaj i uƒçi intenzivnije za uspjeh!",
                closeButton: "U redu"
            },
            subjects: { bhs: "BHS Jezik i Knji≈æevnost", eng: "Engleski Jezik", math: "Matematika" },
            lessonNames: [
                ["Engleski Jezik", "Tjelesni i Zdravstveni Odgoj", "Matematika", "Likovna Kultura", "BHS Jezik i Knji≈æevnost"],
                ["BHS Jezik i Knji≈æevnost", "Dru≈°tvo / Kultura", "Informatika", "BHS Jezik i Knji≈æevnost", "Matematika"],
                ["Muziƒçka/Glazbena Kultura", "BHS Jezik i Knji≈æevnost", "Moja Okolina", "Tjelesni i Zdravstveni Odgoj", "Likovna Kultura"],
                ["Matematika", "Moja Okolina", "Engleski Jezik", "Muziƒçka/Glazbena Kultura", ""]
            ]
        },
        en: {
            mainTitle: "Dorian's Timetable", dark: "Dark", light: "Light", viewToggleWeekly: "Weekly View", viewToggleDaily: "Daily View", currentTitle: "Current Schedule", fullTitle: "Full Weekly Schedule", mobileTitle: "Today's Schedule", timeHeader: "Time", days: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"], lessonStatus: "Current Lesson", breakName: "BREAK", breakStatus: "Break", firstLessonIs: "Today's first lesson is", beforeSchoolStatus: "Classes start soon", beforeSchoolCountdown: "Classes start in", finishedStatus: "Classes have finished!", fridayFinishedTitle: "Classes have finished!", fridayFinishedSubtitle: "Have a nice weekend! Don't forget to finish homework for next week and repeat what you have learned.", morningShift: "First shift", afternoonShift: "Second shift", weekendMessage: "Enjoy your weekend, get ready for the upcoming week!", nextLessonIn: "Next lesson in", weekendPreviewTitle: "The week is over!", weekendPreviewSubtitle: "Next week's classes are in the", examTitle: "Exam Schedule",
            examInDays: "in {days} days", examInOneDay: "in 1 day", examToday: "today",
            examPopup: {
                title: "üö® Exam Alert üö®",
                body: "The {subject} exam is {countdown}!<br><br>Please repeat and study more intensely for success!",
                closeButton: "Okay"
            },
            subjects: { bhs: "BCS Language and Literature", eng: "English Language", math: "Mathematics" },
            lessonNames: [
                ["English Language", "Physical and Health Education", "Mathematics", "Art Culture", "BCS Language and Literature"],
                ["BCS Language and Literature", "Society / Culture", "Informatics", "BCS Language and Literature", "Mathematics"],
                ["Music Culture", "BCS Language and Literature", "My Environment", "Physical and Health Education", "Art Culture"],
                ["Mathematics", "My Environment", "English Language", "Music Culture", ""]
            ]
        },
        tr: {
            mainTitle: "Dorian's Timetable", dark: "Karanlƒ±k", light: "Aydƒ±nlƒ±k", viewToggleWeekly: "Haftalƒ±k G√∂r√ºn√ºm", viewToggleDaily: "G√ºnl√ºk G√∂r√ºn√ºm", currentTitle: "Mevcut Ders", fullTitle: "Haftalƒ±k Ders Programƒ±", mobileTitle: "Bug√ºn√ºn Ders Programƒ±", timeHeader: "Saat", days: ["Pazartesi", "Salƒ±", "√áar≈üamba", "Per≈üembe", "Cuma"], lessonStatus: "Mevcut Ders", breakName: "TENEF√úS", breakStatus: "Tenef√ºs", firstLessonIs: "Bug√ºn√ºn ilk dersi", beforeSchoolStatus: "Dersler yakƒ±nda ba≈ülƒ±yor", beforeSchoolCountdown: "Derslerin ba≈ülamasƒ±na", finishedStatus: "Dersler bitti!", fridayFinishedTitle: "Dersler bitti!", fridayFinishedSubtitle: "ƒ∞yi hafta sonlarƒ±! Gelecek haftanƒ±n √∂devlerini bitirmeyi ve √∂ƒürendiklerinizi tekrar etmeyi unutmayƒ±n.", morningShift: "Sabah√ßƒ±", afternoonShift: "√ñƒülenci", weekendMessage: "Hafta sonunun tadƒ±nƒ± √ßƒ±karƒ±n, yeni haftaya hazƒ±rlanƒ±n!", nextLessonIn: "Bir sonraki ders", weekendPreviewTitle: "Hafta bitti!", weekendPreviewSubtitle: "Gelecek haftaki dersler", previewShiftMorning: "Gelecek hafta dersler sabah.", previewShiftAfternoon: "Gelecek hafta dersler √∂ƒüleden sonra.", examTitle: "Sƒ±nav Takvimi",
            examInDays: "{days} g√ºn i√ßinde", examInOneDay: "1 g√ºn i√ßinde", examToday: "bug√ºn",
            examPopup: {
                title: "üö® Sƒ±nav Uyarƒ±sƒ± üö®",
                body: "{subject} sƒ±navƒ± {countdown}!<br><br>Ba≈üarƒ± i√ßin l√ºtfen daha yoƒüun tekrar yap ve √ßalƒ±≈ü!",
                closeButton: "Tamam"
            },
            subjects: { bhs: "Bo≈ünak Dili ve Edebiyatƒ±", eng: "ƒ∞ngilizce", math: "Matematik" },
            lessonNames: [
                ["ƒ∞ngilizce", "Beden Eƒüitimi", "Matematik", "Resim", "Bo≈ünak Dili ve Edebiyatƒ±"],
                ["Bo≈ünak Dili ve Edebiyatƒ±", "Toplum ve K√ºlt√ºr", "Bili≈üim", "Bo≈ünak Dili ve Edebiyatƒ±", "Matematika"],
                ["M√ºzik", "Bo≈ünak Dili ve Edebiyatƒ±", "√áevre Bilgisi", "Beden Eƒüitimi", "Resim"],
                ["Matematik", "√áevre Bilgisi", "ƒ∞ngilizce", "M√ºzik", ""]
            ]
        },
        it: {
            mainTitle: "Orario di Dorian", dark: "Scuro", light: "Chiaro", viewToggleWeekly: "Vista Settimanale", viewToggleDaily: "Vista Giornaliera", currentTitle: "Lezione Corrente", fullTitle: "Orario Settimanale Completo", mobileTitle: "Orario di Oggi", timeHeader: "Ora", days: ["Luned√¨", "Marted√¨", "Mercoled√¨", "Gioved√¨", "Venerd√¨"], lessonStatus: "Lezione in Corso", breakName: "PAUSA", breakStatus: "Pausa", firstLessonIs: "La prima lezione di oggi √®", beforeSchoolStatus: "Le lezioni iniziano a breve", beforeSchoolCountdown: "Le lezioni iniziano tra", finishedStatus: "Le lezioni sono finite!", fridayFinishedTitle: "Le lezioni sono finite!", fridayFinishedSubtitle: "Buon fine settimana! Non dimenticate di finire i compiti per la prossima settimana e di ripassare ci√≤ che avete imparato.", morningShift: "Turno Mattutino", afternoonShift: "Turno Pomeridiano", weekendMessage: "Goditi il fine settimana, preparati per la prossima!", nextLessonIn: "Prossima lezione tra", weekendPreviewTitle: "La settimana √® finita!", weekendPreviewSubtitle: "Le lezioni della prossima settimana sono nel", examTitle: "Calendario Esami",
            examInDays: "tra {days} giorni", examInOneDay: "tra 1 giorno", examToday: "oggi",
            examPopup: {
                title: "üö® Avviso Esame üö®",
                body: "L'esame di {subject} √® {countdown}!<br><br>Per favore, ripassa e studia pi√π intensamente per avere successo!",
                closeButton: "OK"
            },
            subjects: { bhs: "Lingua e Letteratura BHS", eng: "Lingua Inglese", math: "Matematica" },
            lessonNames: [
                ["Lingua Inglese", "Educazione Fisica e Sanitaria", "Matematica", "Cultura Artistica", "Lingua e Letteratura BHS"],
                ["Lingua e Letteratura BHS", "Societ√† / Cultura", "Informatica", "Lingua e Letteratura BHS", "Matematica"],
                ["Cultura Musicale", "Lingua e Letteratura BHS", "Il Mio Ambiente", "Educazione Fisica e Sanitaria", "Cultura Artistica"],
                ["Matematica", "Il Mio Ambiente", "Lingua Inglese", "Cultura Musicale", ""]
            ]
        },
        sq: {
            mainTitle: "Orari i Dorianit", dark: "Err√´t", light: "Ndritsh√´m", viewToggleWeekly: "Pamja Javore", viewToggleDaily: "Pamja Ditore", currentTitle: "Ora Aktuale", fullTitle: "Orari i Plot√´ Javor", mobileTitle: "Orari i Sot√´m", timeHeader: "Koha", days: ["E H√´n√´", "E Mart√´", "E M√´rkur√´", "E Enjte", "E Premte"], lessonStatus: "Ora n√´ Vazhdim", breakName: "PUSHIM", breakStatus: "Pushim", firstLessonIs: "Ora e par√´ e sotme √´sht√´", beforeSchoolStatus: "M√´simi fillon s√´ shpejti", beforeSchoolCountdown: "M√´simi fillon p√´r", finishedStatus: "M√´simi ka p√´rfunduar!", fridayFinishedTitle: "M√´simi ka p√´rfunduar!", fridayFinishedSubtitle: "Fundjav√´ t√´ k√´ndshme! Mos harroni t√´ p√´rfundoni detyrat e sht√´pis√´ p√´r jav√´n e ardhshme dhe t√´ p√´rs√´risni at√´ q√´ keni m√´suar.", morningShift: "Nd√´rrimi i Paradites", afternoonShift: "Nd√´rrimi i Pasdites", weekendMessage: "Shijoni fundjav√´n, b√´huni gati p√´r jav√´n e ardhshme!", nextLessonIn: "Ora tjet√´r n√´", weekendPreviewTitle: "Java ka mbaruar!", weekendPreviewSubtitle: "Or√´t e jav√´s s√´ ardhshme jan√´ n√´", examTitle: "Orari i Provimeve",
            examInDays: "p√´r {days} dit√´", examInOneDay: "p√´r 1 dit√´", examToday: "sot",
            examPopup: {
                title: "üö® Alarm Provimi üö®",
                body: "Provimi i {subject} √´sht√´ {countdown}!<br><br>Ju lutemi p√´rs√´risni dhe studioni m√´ intensivisht p√´r sukses!",
                closeButton: "N√´ rregull"
            },
            subjects: { bhs: "Gjuha dhe Let√´rsia BHS", eng: "Gjuha Angleze", math: "Matematik√´" },
            lessonNames: [
                ["Gjuha Angleze", "Edukat√´ Fizike dhe Sh√´ndet√´sore", "Matematik√´", "Kultur√´ Artistike", "Gjuha dhe Let√´rsia BHS"],
                ["Gjuha dhe Let√´rsia BHS", "Shoq√´ri / Kultur√´", "Informatik√´", "Gjuha dhe Let√´rsia BHS", "Matematik√´"],
                ["Kultur√´ Muzikore", "Gjuha dhe Let√´rsia BHS", "Mjedisi Im", "Edukat√´ Fizike dhe Sh√´ndet√´sore", "Kultur√´ Artistike"],
                ["Matematik√´", "Mjedisi Im", "Gjuha Angleze", "Kultur√´ Muzikore", ""]
            ]
        }
    };

    const BOSNIAN_MONTHS = [ "januar", "februar", "mart", "april", "maj", "juni", "juli", "august", "septembar", "oktobar", "novembar", "decembar" ];
    const BOSNIAN_DAYS = ["Nedjelja", "Ponedjeljak", "Utorak", "Srijeda", "ƒåetvrtak", "Petak", "Subota"];
    const SHIFT_START_DATE = new Date("2024-09-01T00:00:00");
    let currentLang = 'bs';
    let isWeeklyView = false;
    let simulatedDate = null; 

    function getCurrentTime() {
        return simulatedDate ? new Date(simulatedDate) : new Date();
    }
    
    function getEffectiveDisplayInfo() {
        const now = getCurrentTime();
        
        const currentShift = getShift(now);
        const lastSlot = currentShift.time_slots[currentShift.time_slots.length - 1];
        const [endHour, endMinute] = lastSlot.end.split(':').map(Number);
        const endOfDayMinutes = endHour * 60 + endMinute;

        const dayOfWeek = now.getDay(); 
        const currentTimeInMinutes = now.getHours() * 60 + now.getMinutes();
        
        const isWeekOver = 
            (dayOfWeek === 5 && currentTimeInMinutes >= endOfDayMinutes) || 
            dayOfWeek === 6 || 
            dayOfWeek === 0;   

        if (isWeekOver) {
            const nextMonday = new Date(now);
            const daysToAdd = (8 - dayOfWeek) % 7;
            nextMonday.setDate(now.getDate() + (daysToAdd === 0 ? 7 : daysToAdd) );
            nextMonday.setHours(8, 0, 0, 0); 
            return { dateForShift: nextMonday, isPreview: true };
        }

        return { dateForShift: now, isPreview: false };
    }


    function getShift(date) { 
        const today = date || getCurrentTime(); 
        const diffTime = Math.abs(today - SHIFT_START_DATE);
        const diffWeeks = Math.floor(diffTime / (1000 * 60 * 60 * 24 * 7));
        return diffWeeks % 2 === 0 ? SCHEDULES.afternoon : SCHEDULES.morning;
    }

    function updateDateTime() {
        const now = getCurrentTime();
        let dateStr;
        if (currentLang === 'bs') {
            const dayName = BOSNIAN_DAYS[now.getDay()];
            dateStr = `${dayName}, ${now.getDate()}. ${BOSNIAN_MONTHS[now.getMonth()]} ${now.getFullYear()}.`;
        } else {
            dateStr = now.toLocaleDateString(currentLang, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }
        const timeStr = now.toLocaleTimeString(currentLang, { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        document.getElementById('datetime-display').textContent = `${dateStr}, ${timeStr}`;
    }

    function forceUpdateAll() {
        updateDateTime();
        updateTimetable();
        updateMobileTimetable();
        updateExams();
    }

    function updateExams() {
        const examListContainer = document.getElementById('exam-list');
        examListContainer.innerHTML = '';
        const t = TRANSLATIONS[currentLang];
        const now = getCurrentTime();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

        const sortedExams = EXAMS.sort((a, b) => new Date(a.date) - new Date(b.date));

        sortedExams.forEach(exam => {
            const [year, month, day] = exam.date.split('-').map(Number);
            const examDate = new Date(year, month - 1, day);
            
            const examItem = document.createElement('div');
            examItem.classList.add('exam-item');

            const diffTime = examDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (examDate < today) {
                examItem.classList.add('past');
            } else if (diffDays >= 0 && diffDays <= 7) {
                examItem.classList.add('upcoming');
            }

            const subjectSpan = document.createElement('span');
            subjectSpan.classList.add('exam-subject');
            subjectSpan.textContent = t.subjects[exam.subjectKey];

            const infoContainer = document.createElement('div');
            infoContainer.classList.add('exam-info');

            let formattedDate;
            if (currentLang === 'bs') {
                const dayName = BOSNIAN_DAYS[examDate.getDay()];
                formattedDate = `${dayName}, ${examDate.getDate()}. ${BOSNIAN_MONTHS[examDate.getMonth()]} ${examDate.getFullYear()}.`;
            } else {
                formattedDate = examDate.toLocaleDateString(currentLang, {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                });
            }
            
            const dateTimeSpan = document.createElement('span');
            dateTimeSpan.textContent = `${formattedDate} @ ${exam.time}`;
            infoContainer.appendChild(dateTimeSpan);

            if (diffDays >= 0) {
                 const countdownSpan = document.createElement('span');
                 countdownSpan.classList.add('countdown');
                if (diffDays === 0) {
                    countdownSpan.textContent = `(${t.examToday.charAt(0).toUpperCase() + t.examToday.slice(1)}!)`;
                } else {
                    const text = (diffDays === 1) ? t.examInOneDay : t.examInDays.replace('{days}', diffDays);
                    countdownSpan.textContent = `(${text})`;
                }
                infoContainer.appendChild(countdownSpan);
            }

            examItem.appendChild(subjectSpan);
            examItem.appendChild(infoContainer);
            examListContainer.appendChild(examItem);
        });
    }

    function updateTimetable() {
        const { dateForShift, isPreview } = getEffectiveDisplayInfo();
        const activeShift = getShift(dateForShift);
        const now = getCurrentTime();
        const dayOfWeek = now.getDay() === 0 ? 6 : now.getDay() - 1;
        const currentTimeInMinutes = now.getHours() * 60 + now.getMinutes();
        const t = TRANSLATIONS[currentLang];
        
        const progressBarContainer = document.querySelector('.progress-bar-container');
        const progressBarFill = document.querySelector('.progress-bar-fill');
        progressBarContainer.style.display = 'none';
        
        document.querySelector('.shift-info').textContent = `${t[activeShift.shiftNameKey]} ${activeShift.shiftTimes}`;
        let currentLesson = null;
        
        if (isPreview) {
            let lessonName = `${t.weekendPreviewSubtitle} ${t[activeShift.shiftNameKey].toLowerCase()}`;
            if (currentLang === 'tr') {
                const previewKey = activeShift.shiftNameKey === 'morningShift' ? 'previewShiftMorning' : 'previewShiftAfternoon';
                lessonName = t[previewKey];
            }
            currentLesson = {
                status: t.weekendPreviewTitle,
                name: lessonName,
                time: t.weekendMessage
            };
            document.querySelector('.lesson-time').classList.add('weekend-message');
        } else {
            document.querySelector('.lesson-time').classList.remove('weekend-message');
            if (dayOfWeek >= 5) {
                currentLesson = { status: "üéâ", name: t.weekendMessage, time: "" };
            } else {
                let foundLesson = false;
                for (let i = 0; i < activeShift.time_slots.length; i++) {
                    const timeSlot = activeShift.time_slots[i];
                    const [startHour, startMinute] = timeSlot.start.split(":").map(Number);
                    const startTimeInMinutes = startHour * 60 + startMinute;
                    const [endHour, endMinute] = timeSlot.end.split(":").map(Number);
                    const endTimeInMinutes = endHour * 60 + endMinute;

                    if (currentTimeInMinutes >= startTimeInMinutes && currentTimeInMinutes < endTimeInMinutes) {
                        foundLesson = true;
                        
                        const startTimeInSeconds = startHour * 3600 + startMinute * 60;
                        const endTimeInSeconds = endHour * 3600 + endMinute * 60;
                        const currentTimeInSeconds = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
                        const totalDuration = endTimeInSeconds - startTimeInSeconds;
                        const elapsed = currentTimeInSeconds - startTimeInSeconds;
                        const progress = (elapsed / totalDuration) * 100;

                        progressBarContainer.style.display = 'block';
                        progressBarFill.style.width = `${Math.min(100, Math.max(0, progress))}%`;

                        if (timeSlot.type === "break") {
                            const nextLessonIndex = activeShift.time_slots.findIndex((slot, idx) => idx > i && !slot.type);
                            if (nextLessonIndex !== -1) {
                                const nextLessonSlot = activeShift.time_slots[nextLessonIndex];
                                const nextLessonPeriodIdx = activeShift.time_slots.filter((_, idx) => idx < nextLessonIndex && !activeShift.time_slots[idx].type).length;
                                const nextLessonName = t.lessonNames[nextLessonPeriodIdx][dayOfWeek];
                                if (nextLessonName === '' || nextLessonName === '-') {
                                    currentLesson = { status: t.finishedStatus, name: t.finishedStatus, time: "" };
                                } else {
                                    const [nextStartHour, nextStartMinute] = nextLessonSlot.start.split(":").map(Number);
                                    const nextLessonStartTime = new Date(now);
                                    nextLessonStartTime.setHours(nextStartHour, nextStartMinute, 0, 0);
                                    const diffInSeconds = Math.floor((nextLessonStartTime - now) / 1000);
                                    currentLesson = {
                                        status: t.breakStatus,
                                        name: nextLessonName,
                                        time: `${t.nextLessonIn} ${Math.floor(diffInSeconds / 60)} min. ${diffInSeconds % 60} sec.`
                                    };
                                }
                            } else {
                                currentLesson = { status: t.finishedStatus, name: t.finishedStatus, time: "" };
                            }
                        } else {
                            const lessonIndex = activeShift.time_slots.filter((_, idx) => idx < i && !activeShift.time_slots[idx].type).length;
                            const lessonName = t.lessonNames[lessonIndex][dayOfWeek];

                            if (lessonName === "" || lessonName === "-") {
                                if (dayOfWeek === 4) { 
                                    currentLesson = { status: "üéâ", name: t.fridayFinishedTitle, time: t.fridayFinishedSubtitle };
                                    document.querySelector('.lesson-time').classList.add('weekend-message');
                                } else { 
                                    currentLesson = { status: t.finishedStatus, name: t.finishedStatus, time: "" };
                                }
                                progressBarContainer.style.display = 'none'; 
                            } else {
                                currentLesson = { status: t.lessonStatus, name: lessonName, time: `${timeSlot.start} - ${timeSlot.end}` };
                            }
                        }
                        break;
                    }
                }

                if (!foundLesson) {
                    const firstSlot = activeShift.time_slots[0];
                    const [startHour, startMinute] = firstSlot.start.split(":").map(Number);
                    const startTimeInMinutes = startHour * 60 + startMinute;
                    const lastSlot = activeShift.time_slots[activeShift.time_slots.length - 1];
                    const [endHour, endMinute] = lastSlot.end.split(":").map(Number);
                    const endTimeInMinutes = endHour * 60 + endMinute;
                    
                    if (currentTimeInMinutes < startTimeInMinutes) {
                        const schoolStartTime = new Date(now);
                        schoolStartTime.setHours(startHour, startMinute, 0, 0);
                        const diffInSeconds = Math.floor((schoolStartTime - now) / 1000);
                        let statusText = (diffInSeconds > 3600) ? t.firstLessonIs : t.beforeSchoolStatus;
                        const hours = Math.floor(diffInSeconds / 3600);
                        const minutes = Math.floor((diffInSeconds % 3600) / 60);
                        const seconds = diffInSeconds % 60;
                        const formattedTime = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                        currentLesson = {
                            status: statusText,
                            name: t.lessonNames[0][dayOfWeek],
                            time: `${t.beforeSchoolCountdown} ${formattedTime}`
                        };
                    } else if (currentTimeInMinutes >= endTimeInMinutes) {
                        if (dayOfWeek === 4) {
                            currentLesson = { status: "üéâ", name: t.fridayFinishedTitle, time: t.fridayFinishedSubtitle };
                            document.querySelector('.lesson-time').classList.add('weekend-message');
                        } else {
                            currentLesson = { status: t.finishedStatus, name: t.finishedStatus, time: "" };
                        }
                    } else {
                        const nextUpcomingSlot = activeShift.time_slots.find(slot => !slot.type && (slot.start.split(':').map(Number)[0] * 60 + slot.start.split(':').map(Number)[1]) > currentTimeInMinutes);
                        if (nextUpcomingSlot) {
                            const nextSlotIndex = activeShift.time_slots.indexOf(nextUpcomingSlot);
                            const nextLessonPeriodIdx = activeShift.time_slots.filter((_, idx) => idx < nextSlotIndex && !activeShift.time_slots[idx].type).length;
                            const nextLessonName = t.lessonNames[nextLessonPeriodIdx][dayOfWeek];
                            const [nextStartHour, nextStartMinute] = nextUpcomingSlot.start.split(":").map(Number);
                            const nextLessonStartTime = new Date(now);
                            nextLessonStartTime.setHours(nextStartHour, nextStartMinute, 0, 0);
                            const diffInSeconds = Math.floor((nextLessonStartTime - now) / 1000);
                            currentLesson = {
                                status: t.breakStatus,
                                name: nextLessonName,
                                time: `${t.nextLessonIn} ${Math.floor(diffInSeconds / 60)} min. ${diffInSeconds % 60} sec.`
                            };
                        } else {
                            currentLesson = { status: t.finishedStatus, name: t.finishedStatus, time: "" };
                        }
                    }
                }
            }
        }

        document.querySelector('.status-label').textContent = currentLesson.status;
        document.querySelector('.lesson-name').textContent = currentLesson.name;
        document.querySelector('.lesson-time').textContent = currentLesson.time;

        const tableBody = document.getElementById('timetable-body');
        tableBody.innerHTML = '';
        const lessonTimeSlots = activeShift.time_slots.filter(slot => !slot.type);
        for (let i = 0; i < lessonTimeSlots.length; i++) {
            const row = document.createElement('tr');
            const lessonTime = lessonTimeSlots[i];
            const timeCell = document.createElement('td');
            timeCell.textContent = `${lessonTime.start} - ${lessonTime.end}`;
            row.appendChild(timeCell);
            for (let j = 0; j < t.days.length; j++) {
                const lesson = t.lessonNames[i][j];
                const cell = document.createElement('td');
                cell.textContent = (lesson === '-' || lesson === "") ? '' : lesson;
                const [startHour, startMinute] = lessonTime.start.split(":").map(Number);
                const [endHour, endMinute] = lessonTime.end.split(":").map(Number);
                
                if (!isPreview && j === dayOfWeek && currentTimeInMinutes >= (startHour * 60 + startMinute) && currentTimeInMinutes < (endHour * 60 + endMinute)) {
                    if (lesson !== "" && lesson !== "-") {
                        cell.classList.add('current-lesson');
                        const totalDurationInSeconds = ((endHour * 60 + endMinute) - (startHour * 60 + startMinute)) * 60;
                        const elapsedSecondsInLesson = (currentTimeInMinutes - (startHour * 60 + startMinute)) * 60 + now.getSeconds();
                        const highlight = document.createElement('div');
                        highlight.classList.add('lesson-highlight');
                        highlight.style.height = `${Math.max(0, 1 - (elapsedSecondsInLesson / totalDurationInSeconds)) * 100}%`;
                        highlight.style.transitionDuration = '1s';
                        cell.appendChild(highlight);
                    }
                }
                row.appendChild(cell);
            }
            tableBody.appendChild(row);
        }
    }

    function updateMobileTimetable() {
        const { dateForShift, isPreview } = getEffectiveDisplayInfo();
        const activeShift = getShift(dateForShift);
        const now = getCurrentTime();
        const dayToDisplay = isPreview ? 1 : now.getDay(); 
        const dayOfWeek = dayToDisplay === 0 ? 6 : dayToDisplay - 1;
        
        const currentTimeInMinutes = now.getHours() * 60 + now.getMinutes();
        const t = TRANSLATIONS[currentLang];
        document.getElementById('mobile-time-header').textContent = t.timeHeader;
        const mobileDayHeader = document.getElementById('mobile-day-header');
        const mobileTimetableBody = document.getElementById('mobile-timetable-body');

        if (dayOfWeek >= 5 && !isPreview) {
            mobileDayHeader.textContent = '';
            mobileTimetableBody.innerHTML = `<tr><td colspan="2" style="text-align: center;">${t.weekendMessage}</td></tr>`;
        } else {
            mobileDayHeader.textContent = t.days[dayOfWeek];
            mobileTimetableBody.innerHTML = '';
            const lessonTimeSlots = activeShift.time_slots.filter(slot => !slot.type);
            for (let i = 0; i < lessonTimeSlots.length; i++) {
                const row = document.createElement('tr');
                const lessonTime = lessonTimeSlots[i];
                const timeCell = document.createElement('td');
                timeCell.textContent = `${lessonTime.start} - ${lessonTime.end}`;
                row.appendChild(timeCell);
                const lessonCell = document.createElement('td');
                const lesson = t.lessonNames[i][dayOfWeek];
                lessonCell.textContent = lesson === '-' ? '' : lesson;
                const [startHour, startMinute] = lessonTime.start.split(":").map(Number);
                const [endHour, endMinute] = lessonTime.end.split(":").map(Number);
                
                if (!isPreview && (now.getDay() === 0 ? 6 : now.getDay() -1) === dayOfWeek && currentTimeInMinutes >= (startHour*60+startMinute) && currentTimeInMinutes < (endHour*60+endMinute)) {
                    if (lesson !== "" && lesson !== "-") {
                        lessonCell.classList.add('current-lesson');
                        const totalDurationInSeconds = ((endHour*60+endMinute) - (startHour*60+startMinute)) * 60;
                        const elapsedSecondsInLesson = (currentTimeInMinutes - (startHour*60+startMinute)) * 60 + now.getSeconds();
                        const highlight = document.createElement('div');
                        highlight.classList.add('lesson-highlight');
                        highlight.style.height = `${Math.max(0, 1 - (elapsedSecondsInLesson / totalDurationInSeconds)) * 100}%`;
                        highlight.style.transitionDuration = '1s';
                        lessonCell.appendChild(highlight);
                    }
                }
                row.appendChild(lessonCell);
                mobileTimetableBody.appendChild(row);
            }
        }
    }
    function updateModeButtonText() {
        const button = document.getElementById('mode-toggle');
        const t = TRANSLATIONS[currentLang];
        if (document.body.classList.contains('light-mode')) { button.textContent = `üåô ${t.light}`; } else { button.textContent = `‚òÄÔ∏è ${t.dark}`; }
    }
    function setLanguage(lang) {
        currentLang = lang;
        const t = TRANSLATIONS[lang];
        document.getElementById('main-title').textContent = t.mainTitle;
        document.getElementById('current-title').textContent = t.currentTitle;
        document.getElementById('full-title').textContent = t.fullTitle;
        document.getElementById('mobile-title').textContent = t.mobileTitle;
        document.getElementById('exam-title').textContent = t.examTitle;
        const tableHeader = document.getElementById('table-header').querySelectorAll('th');
        tableHeader[0].textContent = t.timeHeader;
        for (let i = 1; i < tableHeader.length; i++) { tableHeader[i].textContent = t.days[i - 1]; }
        updateModeButtonText();
        updateViewToggleText();
        forceUpdateAll();
    }
    function updateViewToggleText() {
        const viewToggleBtn = document.getElementById('view-toggle');
        if (isWeeklyView) { viewToggleBtn.textContent = TRANSLATIONS[currentLang].viewToggleDaily; } else { viewToggleBtn.textContent = TRANSLATIONS[currentLang].viewToggleWeekly; }
    }
    function toggleMode() {
        document.body.classList.toggle('light-mode');
        updateModeButtonText();
    }
    function toggleView() {
        const fullSchedule = document.getElementById('full-schedule');
        const mobileSchedule = document.getElementById('mobile-schedule');
        isWeeklyView = !isWeeklyView;
        fullSchedule.style.display = isWeeklyView ? 'block' : 'none';
        mobileSchedule.style.display = isWeeklyView ? 'none' : 'block';
        updateViewToggleText();
    }

    // MODIFIED FUNCTION TO USE HTML MODAL
    function checkForUpcomingExamPopup() {
        const t = TRANSLATIONS[currentLang];
        const now = getCurrentTime();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

        const upcomingExams = EXAMS.filter(exam => {
            const [year, month, day] = exam.date.split('-').map(Number);
            const examDate = new Date(year, month - 1, day);
            const diffTime = examDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays >= 0 && diffDays <= 7;
        });

        if (upcomingExams.length > 0) {
            upcomingExams.sort((a, b) => new Date(a.date) - new Date(b.date));
            const soonestExam = upcomingExams[0];

            const [year, month, day] = soonestExam.date.split('-').map(Number);
            const examDate = new Date(year, month - 1, day);
            const diffTime = examDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            let countdownText = '';
            if (diffDays === 0) {
                countdownText = t.examToday;
            } else {
                countdownText = (diffDays === 1) ? t.examInOneDay : t.examInDays.replace('{days}', diffDays);
            }
            
            const subjectName = t.subjects[soonestExam.subjectKey];
            
            // Populate and show the modal
            const modalOverlay = document.getElementById('exam-modal-overlay');
            const modalTitle = document.getElementById('exam-modal-title');
            const modalBody = document.getElementById('exam-modal-body');
            const modalCloseBtn = document.getElementById('exam-modal-close-btn');

            modalTitle.textContent = t.examPopup.title;
            modalBody.innerHTML = t.examPopup.body
                .replace('{subject}', subjectName)
                .replace('{countdown}', countdownText);
            modalCloseBtn.textContent = t.examPopup.closeButton;
            
            modalOverlay.classList.add('visible');
        }
    }


    document.addEventListener('DOMContentLoaded', () => {
        const mainTitle = document.getElementById('main-title');
        const simControls = document.getElementById('simulation-controls');
        const modeToggleButton = document.getElementById('mode-toggle');
        
        // Modal elements and event listeners
        const modalOverlay = document.getElementById('exam-modal-overlay');
        const modalCloseBtn = document.getElementById('exam-modal-close-btn');
        
        const closeModal = () => modalOverlay.classList.remove('visible');

        modalCloseBtn.addEventListener('click', closeModal);
        modalOverlay.addEventListener('click', (event) => {
            if (event.target === modalOverlay) {
                closeModal();
            }
        });

        checkForUpcomingExamPopup();

        modeToggleButton.addEventListener('click', toggleMode);

        let clickCount = 0;
        let firstClickTime = 0;
        
        mainTitle.addEventListener('click', () => {
            const now = Date.now();
            if (now - firstClickTime > 2000) { 
                clickCount = 1;
                firstClickTime = now;
            } else {
                clickCount++;
            }

            if (clickCount === 5) {
                simControls.classList.toggle('visible');
                clickCount = 0;
            }
        });

        document.getElementById('sim-apply-btn').addEventListener('click', () => {
            const pickerValue = document.getElementById('sim-datetime-picker').value;
            if (pickerValue) {
                simulatedDate = new Date(pickerValue);
                forceUpdateAll();
                if (mainInterval) clearInterval(mainInterval);
            }
        });

        document.getElementById('sim-reset-btn').addEventListener('click', () => {
            simulatedDate = null;
            document.getElementById('sim-datetime-picker').value = '';
            if (mainInterval) clearInterval(mainInterval);
            mainInterval = setInterval(forceUpdateAll, 1000);
            forceUpdateAll();
        });
        
        document.getElementById('language-selector').addEventListener('change', (event) => setLanguage(event.target.value));
        document.getElementById('view-toggle').addEventListener('click', toggleView);

        if (window.innerWidth <= 768) {
            isWeeklyView = false;
            document.getElementById('full-schedule').style.display = 'none';
            document.getElementById('mobile-schedule').style.display = 'block';
        } else {
            isWeeklyView = true;
            document.getElementById('full-schedule').style.display = 'block';
            document.getElementById('mobile-schedule').style.display = 'none';
        }
        
        setLanguage(currentLang);
        
        let mainInterval = setInterval(forceUpdateAll, 1000);
    });
</script>

</body>
</html>
